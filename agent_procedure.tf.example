# EXPERIMENTAL: Create Agent via Stored Procedure
# This approach creates a procedure that the user calls to create the agent

# The challenge: Nested $$ delimiters in agent YAML specification
# Snowflake procedures use $$ to delimit the body
# Agent specifications ALSO use $$ to delimit the YAML
# This creates escaping problems

# Attempt 1: Using different delimiters
resource "snowflake_procedure" "create_euno_agent" {
  name     = "create_euno_agent"
  database = snowflake_database.intelligence.name
  schema   = snowflake_schema.agents.name
  
  return_type = "STRING"
  language    = "SQL"
  
  # Use $BODY$ instead of $$ to avoid conflicts
  statement = <<-SQL
    BEGIN
      -- Problem: How to embed the agent YAML which also uses $$?
      -- The agent definition needs its own $$ delimiters
      
      CREATE OR REPLACE AGENT ${var.agent_name}
        COMMENT = 'Euno.ai Data Pipeline Assistant Agent'
        PROFILE = '{
          "display_name": "${var.agent_display_name}",
          "avatar": "${var.agent_avatar}",
          "color": "${var.agent_color}"
        }'
        FROM SPECIFICATION
        -- PROBLEM: This needs $$ but we're already inside a procedure $$
        \$\$
      models:
        orchestration: ${var.orchestration_model}
      
      orchestration:
        budget:
          seconds: ${var.agent_budget_seconds}
          tokens: ${var.agent_budget_tokens}
      
      instructions:
        system: "You are a data agent..."
        orchestration: "You have access to tools..."
        response: "Be concise..."
      
      tools:
        - tool_spec:
            type: "generic"
            name: "euno_instructions"
            description: "Get instructions..."
            input_schema:
              type: "object"
              properties:
                page:
                  type: "number"
              required: []
      
      tool_resources:
        euno_instructions:
          type: "function"
          identifier: "${snowflake_database.intelligence.name}.${snowflake_schema.agents.name}.EUNO_INSTRUCTIONS_WRAPPER"
          execution_environment:
            type: "warehouse"
            warehouse: "${var.warehouse_name}"
        \$\$;
      
      RETURN 'Agent created successfully';
    END
  SQL
  
  comment = "Procedure to create Euno agent - call once after terraform apply"
  
  depends_on = [
    snowflake_function.euno_instructions_wrapper,
    snowflake_function.euno_search_resources_wrapper,
    # ... all wrapper functions
  ]
}

# Alternative: Use JavaScript procedure (different delimiter rules)
resource "snowflake_procedure" "create_euno_agent_js" {
  name     = "create_euno_agent_js"
  database = snowflake_database.intelligence.name
  schema   = snowflake_schema.agents.name
  
  return_type = "STRING"
  language    = "JAVASCRIPT"
  
  statement = <<-JS
    var sql_command = `
      CREATE OR REPLACE AGENT ${var.agent_name}
        COMMENT = 'Euno.ai Data Pipeline Assistant Agent'
        PROFILE = '{
          "display_name": "${var.agent_display_name}",
          "avatar": "${var.agent_avatar}",
          "color": "${var.agent_color}"
        }'
        FROM SPECIFICATION
        $$
      models:
        orchestration: ${var.orchestration_model}
      
      orchestration:
        budget:
          seconds: ${var.agent_budget_seconds}
          tokens: ${var.agent_budget_tokens}
      
      instructions:
        system: "You are a data agent that helps users understand and manage their data pipeline using the Euno AI platform."
        orchestration: >
          You have access to a comprehensive set of primitive tools from the Euno Assistant AI.
          These tools give you granular control over searching, analyzing, and understanding the data pipeline.
          
          IMPORTANT:
          ALWAYS start by calling the tool 'euno_instructions' to get updated guidelines on how to work with Euno.
          START FROM PAGE 1 and read through ALL THE PAGES of the instructions returned by euno_instructions before proceeding to use any other tool.
        
        response: >
          Be concise and accurate in your responses.
          ALWAYS provide full links to resources you mention.
          Format: [{resource.name}](https://api.app.euno.ai/link-to-resource?uri={resource.uri}).
      
      tools:
        - tool_spec:
            type: "generic"
            name: "euno_instructions"
            description: "Get comprehensive instructions on using the Euno MCP server"
            input_schema:
              type: "object"
              properties:
                page:
                  type: "number"
              required: []
        
        - tool_spec:
            type: "generic"
            name: "euno_search_resources"
            description: "Search for data pipeline resources using natural language"
            input_schema:
              type: "object"
              properties:
                query:
                  type: "string"
                reasoning:
                  type: "string"
              required: ["query", "reasoning"]
      
      tool_resources:
        euno_instructions:
          type: "function"
          identifier: "${snowflake_database.intelligence.name}.${snowflake_schema.agents.name}.EUNO_INSTRUCTIONS_WRAPPER"
          execution_environment:
            type: "warehouse"
            warehouse: "${var.warehouse_name}"
        
        euno_search_resources:
          type: "function"
          identifier: "${snowflake_database.intelligence.name}.${snowflake_schema.agents.name}.EUNO_SEARCH_RESOURCES_WRAPPER"
          execution_environment:
            type: "warehouse"
            warehouse: "${var.warehouse_name}"
        $$;
    `;
    
    var stmt = snowflake.createStatement({sqlText: sql_command});
    stmt.execute();
    return 'Agent created successfully';
  JS
  
  comment = "JavaScript procedure to create Euno agent"
  
  depends_on = [
    snowflake_function.euno_instructions_wrapper,
    snowflake_function.euno_search_resources_wrapper,
  ]
}

# User instructions after terraform apply:
# CALL create_euno_agent_js();
# GRANT USAGE ON AGENT ${var.agent_name} TO ROLE ${var.role_name};
